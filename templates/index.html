<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MP4 a Texto</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <h1>Convertir Multimedia a Texto</h1>
        <form id="upload-form" enctype="multipart/form-data">
            <input type="file" id="mp4-file" name="file" accept="video/mp4,audio/mpeg,audio/wav,audio/x-m4a,audio/mp3">
            <button type="submit">Transcribir</button>
        </form>
        <div id="loading" class="hidden">
            <div class="spinner"></div>
            <p>Transcribiendo audio, por favor espera...</p>
        </div>
        <div id="result" class="hidden">
            <h2>Transcripción:</h2>
            <pre id="transcription-text"></pre>
        </div>
        <div id="error" class="hidden">
            <h2>Error:</h2>
            <p id="error-message"></p>
        </div>
    </div>

    <script>
        let pollingInterval;

        document.getElementById('upload-form').addEventListener('submit', async (event) => {
            event.preventDefault();

            const fileInput = document.getElementById('mp4-file');
            const loadingDiv = document.getElementById('loading');
            const resultDiv = document.getElementById('result');
            const errorDiv = document.getElementById('error');
            const transcriptionText = document.getElementById('transcription-text');
            const errorMessage = document.getElementById('error-message');
            const loadingMessage = loadingDiv.querySelector('p');

            // Clear previous states
            clearInterval(pollingInterval);
            loadingDiv.classList.add('hidden');
            resultDiv.classList.add('hidden');
            errorDiv.classList.add('hidden');
            transcriptionText.textContent = '';
            errorMessage.textContent = '';
            loadingMessage.textContent = 'Transcribiendo audio, por favor espera...';

            if (fileInput.files.length === 0) {
                errorMessage.textContent = 'Por favor, selecciona un archivo MP4 o de audio.';
                errorDiv.classList.remove('hidden');
                return;
            }

            const formData = new FormData();
            formData.append('file', fileInput.files[0]);

            loadingDiv.classList.remove('hidden');
            loadingMessage.textContent = 'Subiendo archivo...';

            try {
                const uploadResponse = await fetch('/upload', {
                    method: 'POST',
                    body: formData,
                });

                if (!uploadResponse.ok) {
                    const errorData = await uploadResponse.json();
                    errorMessage.textContent = `Error al iniciar la subida: ${errorData.message || uploadResponse.statusText}`;
                    errorDiv.classList.remove('hidden');
                    loadingDiv.classList.add('hidden');
                    return;
                }

                const responseData = await uploadResponse.json();
                const taskId = responseData.task_id;
                loadingMessage.textContent = `Procesando (ID: ${taskId})...`;

                // Start polling for status
                pollingInterval = setInterval(async () => {
                    try {
                        const statusResponse = await fetch(`/status/${taskId}`);
                        if (!statusResponse.ok) {
                            throw new Error(`HTTP error! status: ${statusResponse.status}`);
                        }
                        const statusData = await statusResponse.json();

                        switch (statusData.status) {
                            case 'received':
                                loadingMessage.textContent = 'Archivo recibido, esperando procesamiento...';
                                break;
                            case 'saving_file':
                                loadingMessage.textContent = 'Guardando archivo...';
                                break;
                            case 'file_saved':
                                loadingMessage.textContent = 'Archivo guardado, preparando transcripción...';
                                break;
                            case 'extracting_audio':
                                loadingMessage.textContent = 'Extrayendo audio (ffmpeg)...';
                                break;
                            case 'audio_extracted':
                                loadingMessage.textContent = 'Audio extraído, iniciando transcripción...';
                                break;
                            case 'ready_for_transcription':
                                loadingMessage.textContent = 'Listo para transcribir...';
                                break;
                            case 'transcribing':
                                loadingMessage.textContent = 'Transcribiendo audio (whisper), esto puede tardar...';
                                break;
                            case 'transcription_completed':
                                loadingMessage.textContent = 'Transcripción completada, leyendo resultado...';
                                break;
                            case 'reading_transcription':
                                loadingMessage.textContent = 'Leyendo transcripción...';
                                break;
                            case 'completed':
                                clearInterval(pollingInterval);
                                transcriptionText.textContent = statusData.transcription;
                                resultDiv.classList.remove('hidden');
                                loadingDiv.classList.add('hidden');
                                break;
                            case 'error':
                                clearInterval(pollingInterval);
                                errorMessage.textContent = `Error en el procesamiento: ${statusData.error}`;
                                errorDiv.classList.remove('hidden');
                                loadingDiv.classList.add('hidden');
                                break;
                            default:
                                loadingMessage.textContent = `Estado desconocido: ${statusData.status}`;
                        }
                    } catch (pollError) {
                        clearInterval(pollingInterval);
                        errorMessage.textContent = `Error al consultar estado: ${pollError.message}`;
                        errorDiv.classList.remove('hidden');
                        loadingDiv.classList.add('hidden');
                    }
                }, 2000); // Poll every 2 seconds

            } catch (fetchError) {
                errorMessage.textContent = `Error de red: ${fetchError.message}`;
                errorDiv.classList.remove('hidden');
                loadingDiv.classList.add('hidden');
            }
        });
    </script>
</body>
</html>